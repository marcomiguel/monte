app.controller("listadoCtrl",["$scope","$location","$rootScope","$http","$timeout","$q","$mdDialog","$mdBottomSheet","$mdSidenav","$mdToast","$animate","$preload","$msj","$filter","$window","$login","$localStorage","$logout","$cacheService",function($scope,$location,$rootScope,$http,$timeout,$q,$mdDialog,$mdBottomSheet,$mdSidenav,$mdToast,$animate,$preload,$msj,$filter,$window,$login,$localStorage,$logout,$cacheService){var ng=$scope,URL=CMSDATA.GLOBAL.URLBASE,URLSESSION=(CMSDATA.GLOBAL.URLVIEW,"session"),URLCLOSESESSION="session/logout",URLLISTNEWS="noticias",URLCOVERS="destacadas/list/",URLLISTSITE="sitio/list",URLDELETE="noticias/eliminar/",URLLISTSITE="sitio/list",URLLISTAUTHOR="user",URLLISTCATEGORY="categoria/index/",URLSEARCHITEMS="noticias/?suggest=",TIMERESULT=500,positionMSj="top right";ng.filterText="";var fechaDesdeGlobal=(new Date).adjustDate(-2190);ng.filterFrom=fechaDesdeGlobal,ng.filterTo=CMSDATA.FILTER.hasta,ng.urlAutocomplete=URL+URLSEARCHITEMS,ng.disabledCloseSession=!1;var nghome=ng.$parent;nghome.preloader=!1,console.log(nghome,"nghome"),ng.user={pictureUrl:!1},ng.urlAjaxHighlight=URL+URLCOVERS,ng.msjEmptyHighlight="No hay portadas asignadas.",$preload.show(),$login.get(URL+URLSESSION).then(function(data){var data=data;data.status?(ng.user.pictureUrl=""==data.response.foto?!1:data.response.foto+"?"+(new Date).getTime(),ng.initList(data),$preload.hide()):($msj.show(CMSDATA.MSJ.MSJ0,positionMSj),delete $localStorage.login,$preload.hide(),$location.path("/"))},function(msgError){$msj.show(CMSDATA.MSJ.MSJ0,positionMSj),delete $localStorage.login,$preload.hide(),$location.path("/")}),ng.closeSession=function(){$logout.get(URL+URLCLOSESESSION)},ng.initList=function(data){ng.filterAuthor=void 0,ng.filterAuthors=[],ng.loadAuthor=function(){$http.get(URL+URLLISTAUTHOR).success(function(data){var data=data;data.status?(ng.filterAuthors=data.response,ng.filterAuthors.unshift({foto:"",nombre:"Todos",slug:""})):$msj.show(CMSDATA.MSJ.MSJ16,positionMSj)}).error(function(msgError){$msj.show(CMSDATA.MSJ.MSJ16,positionMSj)})},ng.loadAuthor(),ng.filterSite=void 0,ng.filterSites=[],ng.loadSite=function(){$cacheService.get(URL+URLLISTSITE).then(function(data){var data=data;data.status?(ng.filterSites=data.response,ng.filterSites.unshift({nombre:"Grupo RPP",slug:"grupo-rpp"})):$msj.show(CMSDATA.MSJ.MSJ17,positionMSj)},function(msgError){$msj.show(CMSDATA.MSJ.MSJ17,positionMSj)})},ng.loadSite(),ng.filterState=void 0,ng.filterStates=$cacheService.getState(),ng.filterTypeContent=void 0,ng.filterTypeContents=$cacheService.getTypeContent(),ng.filterSection=void 0,ng.filterSections=[],ng.loadSection=function(sitio){var _sitio=sitio?sitio:"rpp";$cacheService.get(URL+URLLISTCATEGORY+_sitio+"?type=search_box").then(function(data){var data=data;data.status?ng.filterSections=data.response:$msj.show(CMSDATA.MSJ.MSJ13,positionMSj)},function(msgError){$msj.show(CMSDATA.MSJ.MSJ13,positionMSj)})},ng.loadSection(void 0),ng.changeLoadSectionHeader=function(){var _sitio=ng.filterSite?ng.filterSite.slug:void 0;ng.loadSection(_sitio)},ng.formOptionSearch=!1,ng.layerSearch=!1,$body=angular.element("body"),ng.custom=!0,ng.btnOpenFilter=function($event){var $frm=(angular.element($event.target),angular.element("#contentSearch"));ng.custom=ng.custom===!1?!0:!1,ng.custom?(ng.formOptionSearch=!1,$frm.removeClass("focus"),ng.layerSearch=!1):(ng.formOptionSearch=!0,$frm.addClass("focus"),ng.layerSearch=!0)},ng.hideLayer=function($event){angular.element($event.target);ng.resetLayerSearch()},ng.searchFilterNews=function($event){ng.refresRootDataSearch("self"),ng.resetLayerSearch(),$event.preventDefault()},ng.resetLayerSearch=function(){$frm=angular.element("#contentSearch"),ng.formOptionSearch=!1,$frm.removeClass("focus"),ng.layerSearch=!1,ng.custom=!0},ng.getItemsSearch=function($event,searchText){return $http.get(URL+URLSEARCHITEMS+searchText).then(function(response){return response.data.response})},$timeout(function(){var $elemIptSearch=angular.element('.filterText input[type="search"]');$elemIptSearch.unbind("keyup keypress keydown").bind("keyup",function(e){13===e.which?(ng.refresRootDataSearch("self"),e.stopPropagation(),e.preventDefault()):(e.stopPropagation(),e.preventDefault())})},TIMERESULT+TIMERESULT/4),ng.refresRootDataSearch=function(type){var type=type;if("self"!=type){var blankObjSearch=$rootScope.datasearchOutPage;ng.filterText=blankObjSearch.texto,ng.filterSite=blankObjSearch.sitio,ng.filterSection=blankObjSearch.categoria,ng.filterTypeContent=blankObjSearch.tipo,ng.filterFrom=blankObjSearch.desde,ng.filterTo=blankObjSearch.hasta,ng.filterState=blankObjSearch.estado,ng.filterAuthor=blankObjSearch.autor}var texto=ng.filterText?ng.filterText:"",sitio=ng.filterSite?ng.filterSite:"",categoria=ng.filterSection?ng.filterSection:"",tipo=ng.filterTypeContent?ng.filterTypeContent:"",desde=ng.filterFrom?ng.filterFrom:"",hasta=ng.filterTo?ng.filterTo:"",estado=ng.filterState?ng.filterState:"",autor=ng.filterAuthor?ng.filterAuthor:"";$rootScope.datasearch={texto:texto,sitio:sitio,categoria:categoria,tipo:tipo,desde:desde,hasta:hasta,estado:estado,autor:autor},ng.resetLayerSearch()},ng.refresRootDataSearch("self"),ng.showLoadListNew=!0,ng.news={};var noValidForm=function(){$msj.show(CMSDATA.MSJ.MSJ2,positionMSj),ng.showLoadListNew=!1};ng.DATA={texto:CMSDATA.FILTER.texto,sitio:"",categoria:"",tipo:"",desde:CMSDATA.FILTER.desde,hasta:CMSDATA.FILTER.hasta,estado:"",autor:""};var chipInitial={texto:{nombre:CMSDATA.FILTER.texto,slug:"texto"},sitio:{nombre:CMSDATA.FILTER.sitio,slug:"sitio"}};ng.chipLegend=[chipInitial.texto,chipInitial.sitio];var getChipLegend=function(DATA){var DATA=DATA;ng.chipLegend=[],DATA.texto.length>0&&ng.chipLegend.push({nombre:DATA.texto,slug:"texto"}),ng.chipLegend.push("object"==typeof DATA.sitio?{nombre:DATA.sitio.nombre,slug:"sitio"}:{nombre:CMSDATA.FILTER.sitio,slug:"sitio"}),"object"==typeof DATA.categoria&&ng.chipLegend.push({nombre:DATA.categoria.nombre,slug:"categoria"}),"object"==typeof DATA.tipo&&ng.chipLegend.push({nombre:DATA.tipo.nombre,slug:"tipo"}),"object"==typeof DATA.desde&&"object"==typeof DATA.hasta&&ng.chipLegend.push({nombre:$filter("date")(DATA.desde,"dd/MM/yyyy")+" - "+$filter("date")(DATA.hasta,"dd/MM/yyyy"),slug:"fecha"}),"object"==typeof DATA.estado&&ng.chipLegend.push({nombre:DATA.estado.nombre,slug:"estado"}),"object"==typeof DATA.autor&&ng.chipLegend.push({nombre:DATA.autor.nombre,slug:"autor"})},tiggerSearch=function(DATA){ng.DATA=DATA,ng.newsItems=[],ng.newsBusy=!1,ng.newsAfter="";ng.newsNextPage("search")};$rootScope.$watch("datasearch",function(newValue,oldValue){if(newValue!=oldValue&&!$rootScope.datasearchOutPage){var DATA=$rootScope.datasearch;tiggerSearch(DATA),getChipLegend(DATA)}}),ng.clickChipLegend=function(chip,$index){var chip=chip,$index=$index;switch(ng.chipLegend.splice($index,1),chip.slug){case"texto":$rootScope.datasearch?$rootScope.datasearch.texto=CMSDATA.FILTER.texto:"",ng.filterText=void 0,nghome.filterText=CMSDATA.FILTER.texto;break;case"sitio":$rootScope.datasearch?$rootScope.datasearch.sitio="":ng.DATA.sitio="",ng.filterSite=void 0,nghome.filterSite=void 0;break;case"categoria":$rootScope.datasearch.categoria="",ng.filterSection=void 0,nghome.filterSection=void 0;break;case"tipo":$rootScope.datasearch.tipo="",ng.filterTypeContent=void 0,nghome.filterTypeContent=void 0;break;case"fecha":$rootScope.datasearch?$rootScope.datasearch.desde=fechaDesdeGlobal:"",$rootScope.datasearch?$rootScope.datasearch.hasta=CMSDATA.FILTER.hasta:"",ng.filterFrom=fechaDesdeGlobal,ng.filterTo=CMSDATA.FILTER.hasta,nghome.filterFrom=fechaDesdeGlobal,nghome.filterTo=CMSDATA.FILTER.hasta;break;case"estado":$rootScope.datasearch.estado="",ng.filterState=void 0,nghome.filterState=void 0;break;case"autor":$rootScope.datasearch.autor="",ng.filterAuthor=void 0,nghome.filterAuthor=void 0}var DATA=$rootScope.datasearch?$rootScope.datasearch:ng.DATA;tiggerSearch(DATA),ng.chipLegend.length<=0&&(ng.chipLegend.splice(0,0,chipInitial.texto),ng.chipLegend.splice(1,0,chipInitial.sitio))},ng.newsItems=[],ng.newsBusy=!1,ng.newsAfter="",ng.msjBusy=!1;ng.disabledSearch=!1,ng.total_rows=void 0,ng.newsNextPage=function(type){ng.newsBusy||(ng.newsBusy=!0,ng.msjBusy=!1,ng.disabledSearch=!0,$http.post(URL+URLLISTNEWS+"?cursor="+ng.newsAfter,ng.DATA).success(function(data){var data=data;if(data.status){var items=data.response;if("search"===type&&(ng.total_rows=data.total_rows),items.length>0){for(var i=0;i<items.length;i++)ng.newsItems.push(items[i]);ng.newsAfter=data.last_cursor,ng.newsBusy=!1,ng.showLoadListNew=!1,msjBusy=!1,ng.disabledSearch=!1}else $msj.show(CMSDATA.MSJ.MSJ18,positionMSj),ng.newsBusy=!1,ng.msjBusy=!0,ng.disabledSearch=!1}else noValidForm(),ng.msjBusy=!1,ng.disabledSearch=!1}).error(function(data){noValidForm(),ng.msjBusy=!1,ng.disabledSearch=!1}))},ng.loadRootSearch=function(){if($rootScope.datasearchOutPage){var DATA=$rootScope.datasearchOutPage;tiggerSearch(DATA),getChipLegend(DATA),ng.refresRootDataSearch("blank"),$rootScope.datasearchOutPage=void 0}else{var DATA=$rootScope.datasearch;tiggerSearch(DATA),getChipLegend(DATA)}$timeout(function(){angular.element("#feedly-mini").remove(),angular.element("body > .md-scroll-mask").remove()},4*TIMERESULT)},ng.loadRootSearch(),ng.openCreateNew=function($event,$type,nid){var _nid=nid?nid:"",_type=$type;$preload.show(),$rootScope.objInitNews={response:void 0,type:_type},$location.path("/publicador/noticia/"+_nid)},ng.openDeleteNew=function($event,$title,nid,index){var nid=nid,index=index,confirmDelete=$mdDialog.confirm({title:"Confirmación",content:"¿Está seguro que desea eliminar?",ok:"Aceptar",cancel:"Cancelar"});$mdDialog.show(confirmDelete).then(function(){$preload.show(),deleteNewInList(nid,index)})["finally"](function(){confirmDelete=void 0})};var deleteNewInList=function(nid,index){var _nid=nid,_index=index;_nid?$http["delete"](URL+URLDELETE+_nid).success(function(data){var data=data;ng.newsItems.splice(_index,1),data.status?$preload.hide():($preload.hide(),$msj.show(data.message,positionMSj))}).error(function(data){$preload.hide(),$msj.show(CMSDATA.MSJ.MSJ8,positionMSj)}):($preload.hide(),$msj.show(CMSDATA.MSJ.MSJ8,positionMSj))};ng.returnCategorys=function(categorys){var categorys=categorys,_html="<div class='triangle'></div><div class='ns-popover-tooltip'><div list-popover><h4>Tambien en:</h4><ul>";return angular.forEach(categorys,function(v,i){categorys[i].primary||(_html+="<li>"+$filter("uppercase")(categorys[i].nombre)+"</li>")}),_html+="</ul></div></div>"}}}]);